//User Profiles
[
{
"$lookup":{
    "from": "locations",
    "localField": "personal_info.current_city_id",
    "foreignField": "_id",
    "as": "currentCity"
}
},
{
"$lookup":{
    "from": "normalized_title",
    "localField": "personal_info.normalized_profile_title",
    "foreignField": "title",
    "as": "normalizedtitle"
}
},
{
"$lookup":{
    "from": "standardized_titles",
    "localField": "normalizedtitle.standardized_title_id",
    "foreignField": "_id",
    "as": "standardizedtitle"
}
},
{"$unwind":"$personal_info"},
{"$unwind":"$biolets"},
 {"$project" :
    {"Name":"$personal_info.name", "_id" : 0, "ProfileTitle":"$personal_info.profile_title", "emails" : 1, "ln_profile_url" :1, "Institute":"$biolets.institute_name", "Graduation_Year":"$biolets.to_year", "Normalized_title:":"$personal_info.normalized_profile_title",
    "City":"$currentCity.name", "Country":"$currentCity.country_name", "Standard Title":"$standardizedtitle.title", "FunctionalArea":"$standardizedtitle.functional_area"

}}
]
//--------------------------------------------------------------------------------------------------------------------------------------
//User profiles of all who applied for atleast one job


[{
"$lookup":{
    "from": "job_referral_infos",
    "localField": "_id",
    "foreignField": "candidate_id",
    "as": "jobApp"
}
},
{"$match":{"$expr":{"$ne":[{"$size":"$jobApp"},0]}}},
{
"$lookup":{
    "from": "locations",
    "localField": "personal_info.current_city_id",
    "foreignField": "_id",
    "as": "currentCity"
}
},
{
"$lookup":{
    "from": "normalized_title",
    "localField": "personal_info.normalized_profile_title",
    "foreignField": "title",
    "as": "normalizedtitle"
}
},
{
"$lookup":{
    "from": "standardized_titles",
    "localField": "normalizedtitle.standardized_title_id",
    "foreignField": "_id",
    "as": "standardizedtitle"
}
},
{"$unwind":"$personal_info"},
{"$unwind":"$biolets"},
 {"$project" :
    {"Name":"$personal_info.name", "_id" : 0, "ProfileTitle":"$personal_info.profile_title", "emails" : 1, "ln_profile_url" :1, "Institute":"$biolets.institute_name", "Graduation_Year":"$biolets.to_year", "Normalized_title:":"$personal_info.normalized_profile_title",
    "City":"$currentCity.name", "Country":"$currentCity.country_name", "Standard Title":"$standardizedtitle.title", "FunctionalArea":"$standardizedtitle.functional_area"

}}
]

//----------------------------------------------------------------------------------------------------------------------------------------
//Users who have uploaded their resumes through job peferences

[{
"$lookup":{
    "from": "job_referral_infos",
    "localField": "_id",
    "foreignField": "candidate_id",
    "as": "userProfile"
}
},
{
"$lookup":{
    "from": "locations",
    "localField": "personal_info.current_city_id",
    "foreignField": "_id",
    "as": "currentCity"
}
},
{
"$lookup":{
    "from": "normalized_title",
    "localField": "personal_info.normalized_profile_title",
    "foreignField": "title",
    "as": "normalizedtitle"
}
},
{
"$lookup":{
    "from": "standardized_titles",
    "localField": "normalizedtitle.standardized_title_id",
    "foreignField": "_id",
    "as": "standardizedtitle"
}
},
{
"$lookup":{
    "from": "aux_users",
    "localField": "_id",
    "foreignField": "user_id",
    "as": "job_pref_resume"
}
},
{"$match":{"$ne":["$job_pref_resume.job_preference",null]}},
 {"$project" :
    {"personal_info.name" :1,
    "_id" : 0,
    "personal_info.profile_title" :1,
    "emails" : 1,
    "ln_profile_url" :1,
    "biolets.institute_name":1,
    "biolets.to_year":1,
    "personal_info.normalized_profile_title":1,
    "currentCity.name":1,
    "currentCity.country_name":1,
    "standardizedtitle.title":1,
    "standardizedtitle.functional_area":1

}}
]
//---------------------------------------------------------------------------
//Default fields for networks
[{"$unwind":"$institution_streams"},
{"$match":{"institution_streams.is_primary":true}},
 {
     "$project":{
         "_id":0, "name":1,"host":1,"user_count":1, "institution_streams.name":1, "institution_streams.rank":1
         
     }
    }
]
//----------------------------------------------------------------------------------------------------------
//Network wise job module analysis
[{"$match":{"job_posting_premium":"true"}},
{"$unwind":"$institution_streams"},
{"$match":{"institution_streams.is_primary":true}},
{
"$lookup":{
    "from": "job_postings",
    "localField": "_id",
    "foreignField": "institute_id",
    "as": "jobs"
}
},
{
"$lookup":{
    "from": "job_referral_infos",
    "localField": "_id",
    "foreignField": "institute_id",
    "as": "jobref"
}
},
{
"$lookup":{
    "from": "email_tracking",
    "localField": "_id",
    "foreignField": "college_id",
    "as": "emails"
}
},
{"$match":{"emails.email_type": "job_posting.aggregated"}},
{
"$lookup":{
    "from": "user_profiles",
    "localField": "_id",
    "foreignField": "biolets.institute_id",
    "as": "users"
}
},
{"$lookup":{
    "from": "aux_users",
    "localField": "users._id",
    "foreignField": "user_id",
    "as": "auxusers"
}
},
{"$lookup":{
    "from": "job_postings",
    "localField": "_id",
    "foreignField": "all_institute_ids._id",
    "as": "joblist"
}
},
{
    "$group":{
        "_id": "_id",
        "Institute":{"$first":"$name"},
        "Jobs Posted":{"$sum":{"$cond":[{"$ne":["$jobs._id",null]},1,0]}},
        "Jobs Listed":{"$sum":{"$cond":[{"$ne":["$jobslist._id",null]},1,0]}},
        "Applications":{"$sum":{"$cond":[{"$ne":["$jobref.conversation_id",null]},1,0]}},
        "No of Emails opened":{"$sum":{"$cond":[{"$ne":["emails.first_opened_at",null]},1,0]}},
        "No of Emails clicked":{"$sum":{"$cond":[{"$ne":["emails.first_clicked_at",null]},1,0]}},
        "No of times emails opened":{"$sum":{"$size":"$emails.opened_ats"}},
        "Signedup Users":{"$sum":{"$cond":[{"$ne":["users._id",null]},1,0]}},
        "Job Seekers":{"$sum":{"$cond":[{"$ne":[{"$size":"$auxusers.resume_ids"},0]},1,0]}},
        "People with updated preferences":{"$sum":{"$cond":[{"$ne":[{"$size":"$auxusers.job_preference"},0]},1,0]}},
        "Primary stream":{"$first":"$institution_streams.name"},
        "Primary Rank":{"$first":"$institution_streams.rank"}
    }
}
]
//----------------------------------------------------------------------------------------------------------------------
//Company vs Postings
[{
"$lookup":{
    "from": "institutions",
    "localField": "institute_id",
    "foreignField": "_id",
    "as": "job_posting_network"
}},
{
"$lookup":{
    "from": "institutions",
    "localField": "company_id",
    "foreignField": "_id",
    "as": "company"
}},
{
"$lookup":{
    "from": "job_referral_infos",
    "localField": "_id",
    "foreignField": "job_id",
    "as": "applications_reverts"
}},
{"$unwind":"$applications_reverts"},
{
    "$group":{
        "_id": "$_id",
        "Network":{"$first":"$job_posting_network.name"},
        "Company":{"$first":"$company.name"},
        "Company_size":{"$first":"$company.company_size"},
        "Sector":{"$first":"$company.company_type"},
        "FoundedYear":{"$first":"$company.founded_year"},
        "applications":{ "$sum":{ "$cond":[
            {"$ne":["$applications_reverts.conversation_id",null]},1,0
        ]}},
        "replies":{"$sum":{"$cond":[
            {"$eq":["$applications_reverts.replied",true]},1,0
        ]}}
    }
}

]